CREATE TABLE tooltips (
    url TEXT UNIQUE NOT NULL,
    tooltip TEXT NOT NULL,
    created_on TIMESTAMP NOT NULL DEFAULT now(),
    cached_until TIMESTAMP NOT NULL
);

CREATE INDEX idx_tooltips_url ON tooltips(url);
CREATE INDEX idx_tooltips_cached_until ON tooltips(cached_until);

CREATE FUNCTION delete_old_tooltips() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  row_count int;
BEGIN
  DELETE FROM tooltips WHERE now() > cached_until;
  IF found THEN
    GET DIAGNOSTICS row_count = ROW_COUNT;
    RAISE NOTICE 'DELETEd % row(s) from tooltips', row_count;
  END IF;
  RETURN NULL;
END;
$$;

CREATE TRIGGER trigger_delete_old_tooltips AFTER INSERT ON tooltips EXECUTE PROCEDURE delete_old_tooltips();
